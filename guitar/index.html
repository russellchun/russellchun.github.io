<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vertical Guitar FX</title>
    <style>
        :root {
            --fret-color: #4a4a4a;
            --wood-color: #5d4037;
            --string-color: #c0c0c0;
            --marker-color: #f0f0f0;
            --highlight: #ffd700;
            --ui-bg: rgba(20, 20, 20, 0.95);
            --ui-border: #444;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top UI Bar */
        #controls {
            height: 60px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        #note-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--highlight);
            width: 40px;
            text-align: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button.ui-btn {
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }

        button.ui-btn:active { background: #666; }

        /* Menus (Right Side Slide-ins) */
        .side-menu {
            position: absolute;
            top: 60px;
            right: 0;
            bottom: 0;
            width: 220px;
            background: var(--ui-bg);
            border-left: 1px solid var(--ui-border);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 20;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .side-menu.open {
            transform: translateX(0);
        }

        .menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
        }

        .menu-item:active { background: #444; }
        
        .menu-item.selected {
            color: var(--highlight);
            background: rgba(255, 215, 0, 0.1);
        }

        .menu-header {
            padding: 20px;
            background: #111;
            font-weight: bold;
            border-bottom: 1px solid var(--ui-border);
            text-align: center;
        }

        /* Guitar Neck Container - Vertical */
        #guitar-neck {
            flex-grow: 1;
            background: var(--wood-color);
            position: relative;
            display: flex;
            flex-direction: row;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            overflow-y: auto; 
        }

        .string-col {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.1);
        }

        .string-line {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            transform: translateX(-50%);
            background: var(--string-color);
            box-shadow: 2px 0 4px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 2;
            transition: transform 0.1s;
        }

        .fret-cell {
            width: 100%;
            border-bottom: 4px solid var(--fret-color);
            box-sizing: border-box;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        /* Vertical Fret Spacing */
        .fret-0 { height: 60px; background: #3e2723; border-bottom: 8px solid #fff; }
        .fret-1 { height: 13%; }
        .fret-2 { height: 12%; }
        .fret-3 { height: 11%; }
        .fret-4 { height: 10%; }
        .fret-5 { height: 9%; }
        .fret-6 { height: 8%; }
        .fret-7 { height: 7%; }
        .fret-8 { height: 6%; }
        .fret-9 { height: 6%; }
        .fret-10 { height: 5%; }
        .fret-11 { height: 5%; }
        .fret-12 { height: 5%; }

        /* Markers */
        .dot {
            width: 15px; height: 15px;
            background: var(--marker-color);
            border-radius: 50%; opacity: 0.6; pointer-events: none;
        }
        
        .finger-marker {
            width: 22px; height: 22px;
            background: var(--highlight);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--highlight);
            position: absolute; z-index: 5;
            display: none;
        }
        .finger-marker.visible { display: block; }

        .vibrating { animation: vibrate 0.08s infinite linear; }

        @keyframes vibrate {
            0% { transform: translateX(-50%) translate(0, 0); }
            25% { transform: translateX(-50%) translate(2px, 0); }
            75% { transform: translateX(-50%) translate(-2px, 0); }
            100% { transform: translateX(-50%) translate(0, 0); }
        }

        /* Overlay */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; color: white;
            flex-direction: column; text-align: center;
        }

    </style>
</head>
<body>

    <div id="overlay" onclick="initAudio()">
        <h1>Guitar FX Sim</h1>
        <p>Tap to Start</p>
        <p style="font-size: 0.8rem; color: #aaa; margin-top: 20px;">Turn Volume UP & Silent Mode OFF</p>
    </div>

    <div id="controls">
        <div id="note-display">--</div>
        <div class="btn-group">
            <button class="ui-btn" onclick="toggleMenu('effects-menu')">Effects</button>
            <button class="ui-btn" onclick="toggleMenu('chord-menu')">Chords</button>
        </div>
    </div>

    <div id="guitar-neck">
        </div>

    <div id="chord-menu" class="side-menu">
        <div class="menu-header">Common Chords</div>
        <div id="chord-list"></div>
    </div>

    <div id="effects-menu" class="side-menu">
        <div class="menu-header">Effects Pedal</div>
        <div class="menu-item selected" onclick="setEffect('clean', this)">Clean</div>
        <div class="menu-item" onclick="setEffect('crunch', this)">Crunch</div>
        <div class="menu-item" onclick="setEffect('distortion', this)">Distortion</div>
        <div class="menu-item" onclick="setEffect('fuzz', this)">Fuzz</div>
        <div class="menu-item" onclick="setEffect('chorus', this)">Chorus</div>
        <div class="menu-item" onclick="setEffect('reverb', this)">Reverb</div>
    </div>

<script>
    // --- Audio Engine ---
    let audioCtx;
    let masterGain;
    let inputNode; // Entry point
    let currentEffectNodes = []; // To track and disconnect old effects

    const openStringFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];
    const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    function initAudio() {
        if (audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();

        // Master Volume
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.5;
        masterGain.connect(audioCtx.destination);

        // Input Hub
        inputNode = audioCtx.createGain();
        
        // Start with Clean
        setEffect('clean');

        document.getElementById('overlay').style.display = 'none';
    }

    // Helper: Clean up previous effects
    function clearEffects() {
        inputNode.disconnect();
        currentEffectNodes.forEach(node => {
            try { node.disconnect(); } catch(e){}
        });
        currentEffectNodes = [];
    }

    // Helper: Create Distortion Curve
    function makeDistortionCurve(amount) {
        let k = amount,
            n_samples = 44100,
            curve = new Float32Array(n_samples),
            deg = Math.PI / 180,
            i = 0, x;
        for ( ; i < n_samples; ++i ) {
            x = i * 2 / n_samples - 1;
            // Classic sigmoid sigmoid function
            curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
    }

    // Helper: Impulse Response for Reverb
    function createReverbImpulse(duration) {
        const rate = audioCtx.sampleRate;
        const length = rate * duration;
        const impulse = audioCtx.createBuffer(2, length, rate);
        const left = impulse.getChannelData(0);
        const right = impulse.getChannelData(1);
        for (let i = 0; i < length; i++) {
            const decay = Math.pow(1 - i / length, 2);
            left[i] = (Math.random() * 2 - 1) * decay;
            right[i] = (Math.random() * 2 - 1) * decay;
        }
        return impulse;
    }

    // --- EFFECT BUILDERS ---

    function buildDistortionChain(amount, lowPassFreq, postGainVal) {
        // 1. Pre-Gain (Drive)
        const preGain = audioCtx.createGain();
        preGain.gain.value = 1.0; // Can be boosted for more drive

        // 2. WaveShaper (The Distortion)
        const shaper = audioCtx.createWaveShaper();
        shaper.curve = makeDistortionCurve(amount);
        shaper.oversample = '4x';

        // 3. BiquadFilter (Cabinet Sim) - CRITICAL for removing "fizz"
        const cabinetSim = audioCtx.createBiquadFilter();
        cabinetSim.type = 'lowpass';
        cabinetSim.frequency.value = lowPassFreq; 

        // 4. Post-Gain (Level matching)
        const postGain = audioCtx.createGain();
        postGain.gain.value = postGainVal;

        // Connect: Input -> Pre -> Shaper -> Cab -> Post -> Master
        inputNode.connect(preGain);
        preGain.connect(shaper);
        shaper.connect(cabinetSim);
        cabinetSim.connect(postGain);
        postGain.connect(masterGain);

        currentEffectNodes.push(preGain, shaper, cabinetSim, postGain);
    }

    function setEffect(type, uiElement) {
        if (!audioCtx) return;

        if (uiElement) {
            document.querySelectorAll('#effects-menu .menu-item').forEach(el => el.classList.remove('selected'));
            uiElement.classList.add('selected');
            toggleMenu('effects-menu');
        }

        clearEffects();

        switch (type) {
            case 'clean':
                inputNode.connect(masterGain);
                break;

            case 'crunch':
                // Lower gain, slightly more open filter
                buildDistortionChain(50, 5000, 0.8);
                break;

            case 'distortion':
                // High gain, tighter filter (rock stack sound)
                buildDistortionChain(400, 3200, 0.6);
                break;

            case 'fuzz':
                // Extreme gain, slightly buzzy filter
                buildDistortionChain(1500, 4000, 0.4);
                break;

            case 'chorus':
                // Split path: Dry + Wet (Modulated Delay)
                
                // Dry path
                const dryGain = audioCtx.createGain();
                dryGain.gain.value = 0.7;
                inputNode.connect(dryGain);
                dryGain.connect(masterGain);

                // Wet path components
                const delay = audioCtx.createDelay();
                delay.delayTime.value = 0.03; // 30ms base delay
                
                const lfo = audioCtx.createOscillator();
                lfo.type = 'sine';
                lfo.frequency.value = 1.5; // Speed of swirl (Hz)

                const lfoGain = audioCtx.createGain();
                lfoGain.gain.value = 0.002; // Depth of swirl

                const wetGain = audioCtx.createGain();
                wetGain.gain.value = 0.5;

                // Wiring
                // LFO -> LFO Gain -> Delay.delayTime
                lfo.connect(lfoGain);
                lfoGain.connect(delay.delayTime);
                
                // Input -> Delay -> WetGain -> Master
                inputNode.connect(delay);
                delay.connect(wetGain);
                wetGain.connect(masterGain);

                lfo.start();

                currentEffectNodes.push(dryGain, delay, lfo, lfoGain, wetGain);
                break;

            case 'reverb':
                const convolver = audioCtx.createConvolver();
                convolver.buffer = createReverbImpulse(2.0);
                
                // Mix Dry and Wet
                const revDry = audioCtx.createGain();
                revDry.gain.value = 0.8;
                const revWet = audioCtx.createGain();
                revWet.gain.value = 0.6;

                inputNode.connect(revDry);
                revDry.connect(masterGain);

                inputNode.connect(convolver);
                convolver.connect(revWet);
                revWet.connect(masterGain);

                currentEffectNodes.push(convolver, revDry, revWet);
                break;
        }
    }

    function playTone(freq) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.type = 'sawtooth'; 
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        // Envelope
        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01); 
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.0); 

        osc.connect(gainNode);
        gainNode.connect(inputNode); // Connect to the start of the chain

        osc.start();
        osc.stop(audioCtx.currentTime + 1.0);
    }

    function getNoteFreq(stringIndex, fretIndex) {
        const baseFreq = openStringFreqs[stringIndex];
        return baseFreq * Math.pow(2, fretIndex / 12);
    }

    function getNoteName(stringIndex, fretIndex) {
        const offsets = [4, 9, 2, 7, 11, 4];
        const currentOffset = offsets[stringIndex];
        return noteNames[(currentOffset + fretIndex) % 12];
    }

    // --- UI Generation ---

    const neck = document.getElementById('guitar-neck');
    const numFrets = 12;
    
    for (let s = 0; s < 6; s++) {
        const col = document.createElement('div');
        col.className = 'string-col';
        col.id = `string-${s}`;
        
        const line = document.createElement('div');
        line.className = 'string-line';
        line.style.width = `${(6 - s) + 1}px`; 
        col.appendChild(line);

        for (let f = 0; f <= numFrets; f++) {
            const cell = document.createElement('div');
            cell.className = `fret-cell fret-${f}`;
            cell.dataset.string = s;
            cell.dataset.fret = f;

            // Dots logic
            if (s === 2) {
                if ([3, 5, 7, 9].includes(f)) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.style.position = "absolute"; dot.style.right = "-7px"; dot.style.zIndex = "0";
                    cell.appendChild(dot);
                } else if (f === 12) {
                     const dotL = document.createElement('div');
                     dotL.className = 'dot';
                     dotL.style.position = "absolute"; dotL.style.left = "-10px"; 
                     cell.appendChild(dotL);
                     const dotR = document.createElement('div');
                     dotR.className = 'dot';
                     dotR.style.position = "absolute"; dotR.style.right = "-10px"; 
                     cell.appendChild(dotR);
                }
            }

            const finger = document.createElement('div');
            finger.className = 'finger-marker';
            finger.id = `marker-${s}-${f}`;
            cell.appendChild(finger);

            col.appendChild(cell);
        }
        neck.appendChild(col);
    }

    // --- Interaction Logic ---

    const noteDisplay = document.getElementById('note-display');
    let lastPlayedString = null;

    function triggerNote(stringIdx, fretIdx) {
        stringIdx = parseInt(stringIdx);
        fretIdx = parseInt(fretIdx);
        
        playTone(getNoteFreq(stringIdx, fretIdx));
        noteDisplay.innerText = getNoteName(stringIdx, fretIdx);

        const stringCol = document.getElementById(`string-${stringIdx}`);
        const line = stringCol.querySelector('.string-line');
        
        if (line.vibrationTimer) clearTimeout(line.vibrationTimer);
        line.classList.remove('vibrating');
        void line.offsetWidth; 
        line.classList.add('vibrating');

        line.vibrationTimer = setTimeout(() => {
            line.classList.remove('vibrating');
        }, 500);
    }

    neck.addEventListener('pointerdown', (e) => {
        const t = e.target.closest('.fret-cell');
        if (t) triggerNote(t.dataset.string, t.dataset.fret);
    });

    neck.addEventListener('pointermove', (e) => {
        if (e.buttons !== 1 && e.type !== 'touchmove') return;
        
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        const t = document.elementFromPoint(cx, cy);
        if (!t) return;

        const cell = t.closest('.fret-cell');
        if (cell) {
            const id = `${cell.dataset.string}-${cell.dataset.fret}`;
            if (lastPlayedString !== id) {
                triggerNote(cell.dataset.string, cell.dataset.fret);
                lastPlayedString = id;
            }
        }
    });
    window.addEventListener('pointerup', () => { lastPlayedString = null; });


    // --- Menu Logic ---

    function toggleMenu(menuId) {
        // Close all other menus first
        document.querySelectorAll('.side-menu').forEach(m => {
            if (m.id !== menuId) m.classList.remove('open');
        });
        document.getElementById(menuId).classList.toggle('open');
    }

    // --- Chord Data & Generation ---
    const chordData = {
        'A Major': [-1, 0, 2, 2, 2, 0], 'A Minor': [-1, 0, 2, 2, 1, 0],
        'C Major': [-1, 3, 2, 0, 1, 0], 'D Major': [-1, -1, 0, 2, 3, 2],
        'E Major': [0, 2, 2, 1, 0, 0], 'E Minor': [0, 2, 2, 0, 0, 0],
        'G Major': [3, 2, 0, 0, 0, 3]
    };

    const chordList = document.getElementById('chord-list');
    Object.keys(chordData).forEach(name => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerText = name;
        div.onclick = () => playChord(name);
        chordList.appendChild(div);
    });

    function playChord(name) {
        document.querySelectorAll('.finger-marker').forEach(el => el.classList.remove('visible'));
        toggleMenu('chord-menu');
        noteDisplay.innerText = name;

        let delay = 0;
        chordData[name].forEach((fret, sIdx) => {
            if (fret !== -1) {
                const m = document.getElementById(`marker-${sIdx}-${fret}`);
                if (m) m.classList.add('visible');
                setTimeout(() => triggerNote(sIdx, fret), delay);
                delay += 50; 
            }
        });
    }

</script>
</body>
</html>
